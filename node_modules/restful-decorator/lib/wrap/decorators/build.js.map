{"version":3,"file":"build.js","sourceRoot":"","sources":["build.ts"],"names":[],"mappings":";;;;AAAA;;GAEG;AACH,gFAKgC;AAKhC,qEAAgC;AA2BhC;;GAEG;AACH,SAAgB,mBAAmB,CAAuC,MAAuD;IAEhI,OAAO,UAAU,OAAsF,EACtG,iBAAwD,IAAI;QAG5D,IAAI,OAAO,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,CAAC,cAAc,IAAI,IAAI,IAAI,cAAc,KAAK,IAAI,CAAC,EACjG;YACC,CAAC,CAAC,cAAc,EAAE,OAAO,CAAC,GAAG,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC,CAAC;SAC9C;QAED,IAAI,OAAO,cAAc,KAAK,SAAS,EACvC;YACC,cAAc,GAAG;gBAChB,WAAW,EAAE,cAAc;aACI,CAAA;SAChC;QAED,cAAc,GAAG,cAAc,IAAI,EAAiC,CAAC;QAErE,IAAI,cAAc,CAAC,WAAW,IAAI,IAAI,EACtC;YACC,cAAc,CAAC,WAAW,GAAG,IAAI,CAAC;SAClC;QAED,IAAI,cAAc,CAAC,UAAU,IAAI,IAAI,IAAI,cAAc,CAAC,WAAW,EACnE;YACC,cAAc,CAAC,UAAU,GAAG,IAAI,CAAC;SACjC;QAED,IAAI,cAAc,CAAC,OAAO,EAC1B;YACC,OAAO,GAAG,cAAc,CAAC,OAAO,CAAA;SAChC;QAED,IAAI,OAAO,IAAI,OAAO,OAAO,IAAI,UAAU,EAC3C;YACC,MAAM,IAAI,SAAS,CAAC,8BAA8B,CAAC,CAAA;SACnD;QAED,IAAI,EAAE,WAAW,EAAE,GAAG,cAAc,CAAC;QAErC,MAAM,GAAG,GAAG,OAAyD,CAAC;QAEtE,OAAO,GAAG,CAAC,CAAC,IAA0D,EAAE,EAAE;YAEzE,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC;YAE9B,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,EAC5B;gBACC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;aAC/B;YAED,IAAI,MAAM,EACV;gBACC,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAW,CAAC,CAAC;gBAE/C,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,EAC5B;oBACC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;iBAC/B;aACD;YAED,IAAI,GAAG,EACP;gBACC,MAAM,EAAE,QAAQ,GAAG,IAAI,CAAC,QAAQ,EAAE,MAAM,GAAG,IAAI,CAAC,MAAM,EAAE,IAAI,GAAG,IAAI,CAAC,IAAI,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,IAAW,CAAC,IAAI,IAAI,CAAC;gBAEpH,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,EAC5B;oBACC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;iBAC/B;gBAED,IAAI,GAAG;oBACN,GAAG,IAAI;oBACP,QAAQ;oBACR,MAAM;oBACN,IAAI;iBACJ,CAAC;aACF;YAEA,cAA8C,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC;YAE/E,IAAI,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,SAAS,EACvC;gBACC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;gBAEtB,6BAA6B;gBAE7B,OAAO;oBACN,GAAG,IAAI;oBACP,cAAc,EAAE,cAA6C;oBAC7D,WAAW,EAAE,kBAAQ;yBACnB,OAAO,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;yBAChD,IAAI,CAAC,UAAU,GAAG;wBAElB,aAAa;wBACb,IAAI,CAAC,QAAQ,CAAC,YAAY,GAAG,GAAG,CAAC;wBAEjC,IAAI,CAAC,QAAQ,CAAC,SAAS,GAAG,GAAG,CAAC;wBAE9B,aAAa;wBACb,IAAI,GAAG,IAAI,GAAG,CAAC,OAAO,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,EACxE;4BACC,aAAa;4BACb,IAAI,CAAC,QAAQ,CAAC,YAAY,GAAG,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC;yBACzD;wBAED,IAAK,cAA8C,CAAC,UAAU,EAC9D;4BACC,aAAa;4BACb,IAAI,CAAC,QAAQ,CAAC,kBAAkB,GAAG,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC;4BAC9D,OAAO,IAAI,CAAC,QAAQ,CAAC,YAAY,GAAG,GAAG,CAAC,IAAI,CAAC;yBAC7C;wBAED,OAAO,GAAG,CAAC;oBACZ,CAAC,CAAC;iBAEH,CAAC;aACF;YAED,OAAO;gBACN,GAAG,IAAI;gBACP,cAAc,EAAE,cAA6C;aAC7D,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,OAAO,IAAA,eAAc,EAAI,OAAc,CAAC,CAAC;IAC1C,CAAC,CAAC;AACH,CAAC;AAhID,kDAgIC;AAED,kBAAe,mBAAmB,CAAC","sourcesContent":["/**\n * Created by user on 2019/6/7.\n */\nimport _methodBuilder, {\n\tIHandleDescriptor,\n\tConstructorLikeType,\n\tIMemberMethods,\n\tIHandleDescriptor2, IHandleDescriptor3, IHandleDescriptorReturn2,\n} from '../../decorators/build';\nimport subobject, { IMethod } from '../../helper/subobject';\nimport { AbstractHttpClient } from '../abstract';\nimport { AxiosRequestConfig } from 'axios';\nimport { IParamMetadata } from '../../decorators/body';\nimport Bluebird from 'bluebird';\n\nexport interface IMethodBuilderCache\n{\n\trequestConfig: AxiosRequestConfig,\n\tbool: boolean,\n\trequestConfigNew: AxiosRequestConfig,\n\tparamMetadata: IParamMetadata,\n\tautoRequest?: boolean,\n\trequested?: boolean,\n}\n\nexport interface IMethodBuilderOptions<T extends object, R>\n{\n\thandler?: IHandleDescriptor3<T, R & IMethodBuilderCache>\n\t/**\n\t * @default true\n\t */\n\tautoRequest?: boolean;\n\n\t/**\n\t * 當 autoRequest 啟用時 會自動將回傳內容改為 response.data\n\t * @default true\n\t */\n\treturnData?: boolean;\n}\n\n/**\n * preset type for methodBuilder\n */\nexport function createMethodBuilder<T extends AbstractHttpClient, R = {}>(wrapFn?: IHandleDescriptor2<T, R & IMethodBuilderCache>)\n{\n\treturn function (handler?: IHandleDescriptor3<T, R & IMethodBuilderCache> | IMethodBuilderOptions<T, R>,\n\t\tbuilderOptions: IMethodBuilderOptions<T, R> | boolean = true,\n\t)\n\t{\n\t\tif (handler && typeof handler === 'object' && (builderOptions == null || builderOptions === true))\n\t\t{\n\t\t\t([builderOptions, handler] = [handler, null]);\n\t\t}\n\n\t\tif (typeof builderOptions === 'boolean')\n\t\t{\n\t\t\tbuilderOptions = {\n\t\t\t\tautoRequest: builderOptions,\n\t\t\t} as IMethodBuilderOptions<T, R>\n\t\t}\n\n\t\tbuilderOptions = builderOptions || {} as IMethodBuilderOptions<T, R>;\n\n\t\tif (builderOptions.autoRequest == null)\n\t\t{\n\t\t\tbuilderOptions.autoRequest = true;\n\t\t}\n\n\t\tif (builderOptions.returnData == null && builderOptions.autoRequest)\n\t\t{\n\t\t\tbuilderOptions.returnData = true;\n\t\t}\n\n\t\tif (builderOptions.handler)\n\t\t{\n\t\t\thandler = builderOptions.handler\n\t\t}\n\n\t\tif (handler && typeof handler != 'function')\n\t\t{\n\t\t\tthrow new TypeError(`typeof handler != 'function'`)\n\t\t}\n\n\t\tlet { autoRequest } = builderOptions;\n\n\t\tconst old = handler as IHandleDescriptor3<T, R & IMethodBuilderCache>;\n\n\t\thandler = ((data: IHandleDescriptorReturn2<T, R & IMethodBuilderCache>) =>\n\t\t{\n\t\t\tconst oldThis = data.thisArgv;\n\n\t\t\tif (data.autoRequest == null)\n\t\t\t{\n\t\t\t\tdata.autoRequest = autoRequest;\n\t\t\t}\n\n\t\t\tif (wrapFn)\n\t\t\t{\n\t\t\t\tdata = wrapFn.call(data.thisArgv, data as any);\n\n\t\t\t\tif (data.autoRequest == null)\n\t\t\t\t{\n\t\t\t\t\tdata.autoRequest = autoRequest;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (old)\n\t\t\t{\n\t\t\t\tconst { thisArgv = data.thisArgv, method = data.method, argv = data.argv } = old.call(oldThis, data as any) || data;\n\n\t\t\t\tif (data.autoRequest == null)\n\t\t\t\t{\n\t\t\t\t\tdata.autoRequest = autoRequest;\n\t\t\t\t}\n\n\t\t\t\tdata = {\n\t\t\t\t\t...data,\n\t\t\t\t\tthisArgv,\n\t\t\t\t\tmethod,\n\t\t\t\t\targv,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t(builderOptions as IMethodBuilderOptions<T, R>).autoRequest = data.autoRequest;\n\n\t\t\tif (data.autoRequest && !data.requested)\n\t\t\t{\n\t\t\t\tdata.requested = true;\n\n\t\t\t\t//console.dir(data.thisArgv);\n\n\t\t\t\treturn {\n\t\t\t\t\t...data,\n\t\t\t\t\tbuilderOptions: builderOptions as IMethodBuilderOptions<T, R>,\n\t\t\t\t\treturnValue: Bluebird\n\t\t\t\t\t\t.resolve(data.thisArgv.$http(data.requestConfig))\n\t\t\t\t\t\t.then(function (ret)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tdata.thisArgv.$returnValue = ret;\n\n\t\t\t\t\t\t\tdata.thisArgv.$response = ret;\n\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tif (ret && ret.request && ret.request.res && ret.request.res.responseUrl)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\t\tdata.thisArgv.$responseUrl = ret.request.res.responseUrl;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif ((builderOptions as IMethodBuilderOptions<T, R>).returnData)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\t\tdata.thisArgv.$returnValueSource = data.thisArgv.$returnValue;\n\t\t\t\t\t\t\t\treturn data.thisArgv.$returnValue = ret.data;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn ret;\n\t\t\t\t\t\t})\n\t\t\t\t\t,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\t...data,\n\t\t\t\tbuilderOptions: builderOptions as IMethodBuilderOptions<T, R>,\n\t\t\t};\n\t\t});\n\n\t\treturn _methodBuilder<T>(handler as any);\n\t};\n}\n\nexport default createMethodBuilder;\n"]}